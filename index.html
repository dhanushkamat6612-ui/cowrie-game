<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kamat Studio - Kaude</title>
  <style>
    body { text-align: center; font-family: sans-serif; background: #fff5e6; padding: 0; margin: 0; touch-action: manipulation; overflow: hidden; }
    #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 2000; }
    #setup-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff5e6; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1500; }
    #game-container { padding: 10px; display: none; }
    
    .board { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); width: 94vw; height: 94vw; max-width: 380px; max-height: 380px; margin: 10px auto; border: 4px solid #3e2723; background: #FFFDD0; }
    .cell { border: 1px solid #3e2723; position: relative; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; }
    
    .inner-layer { background-color: #e8f5e9 !important; }
    .waiting-box { background-color: #a5d6a7 !important; border: 3px solid #2e7d32 !important; box-sizing: border-box; }
    .win-block { background-color: #ffd700 !important; border: 3px double #3e2723; }
    
    .safe { background-image: linear-gradient(45deg, transparent 48%, #3e2723 50%, transparent 52%), linear-gradient(-45deg, transparent 48%, #3e2723 50%, transparent 52%); }
    .highlight { background-color: rgba(46, 125, 50, 0.4) !important; border: 4px solid #2e7d32 !important; z-index: 20; }
    
    .token { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid #000; margin: 1px; transition: all 0.3s ease; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
    .red-t { background: #ff5252; } .blue-t { background: #2196f3; } .green-t { background: #4caf50; } .yellow-t { background: #ffeb3b; }
    .selected { transform: scale(1.6); box-shadow: 0 0 10px #000; z-index: 100; border-color: white; }

    .cowrie { width: 45px; }
    .spinning { animation: toss 0.6s ease-out; }
    @keyframes toss { 0% { transform: scale(0.5); } 100% { transform: scale(1) rotate(-360deg); } }
    
    button { padding: 12px 25px; background: #d32f2f; color: white; border: none; border-radius: 50px; font-weight: bold; margin-top: 10px; font-size: 16px; cursor: pointer; }
    .turn-indicator { font-weight: bold; padding: 10px 25px; border-radius: 30px; color: white; margin-bottom: 5px; display: inline-block; }
  </style>
</head>
<body>

  <div id="boot-screen"><h1 style="color:white;">KAMAT STUDIO</h1></div>

  <div id="setup-screen">
    <div style="background:white; padding:25px; border-radius:20px; width:85%; max-width:320px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
      <h2 style="color:#3e2723; margin:0 0 10px 0;">Kaude</h2>
      <p>Number of Players (2-4)</p>
      <input type="number" id="pCount" min="2" max="4" value="2" oninput="drawInputs()" style="width:60px; text-align:center; padding:5px; font-size:18px;">
      <div id="pNames" style="margin: 15px 0;"></div>
      <button onclick="launch()">Start Game</button>
    </div>
  </div>

  <div id="game-container">
    <div id="turn-box" class="turn-indicator"></div>
    <div id="score" style="font-weight:bold; font-size:24px; margin: 5px;">Roll: 0</div>
    <div id="cowrieArea" style="display:flex; justify-content:center; gap:8px; min-height:60px;"></div>
    <button id="tossBtn" onclick="throwKaude()">Toss Cowries</button>
    <div class="board" id="gameBoard"></div>
  </div>

  <script>
    // Logic: Pathing and Rarity
    const outerRing = [2, 1, 0, 5, 10, 15, 20, 21, 22, 23, 24, 19, 14, 9, 4, 3];
    const innerRing = [7, 6, 11, 16, 17, 18, 13, 8];
    const startSquares = [2, 22, 10, 14]; // Red, Blue, Green, Yellow starting X
    const colors = ['red', 'blue', 'green', 'yellow'];
    const hex = { red: '#ff5252', blue: '#2196f3', green: '#4caf50', yellow: '#ffeb3b' };

    let players = [], turnIdx = 0, roll = 0, cells = [];

    function drawInputs() {
      const c = document.getElementById('pCount').value;
      const box = document.getElementById('pNames'); box.innerHTML = '';
      for(let i=0; i<c; i++) box.innerHTML += `<input type="text" id="n${i}" style="width:85%; margin:5px; padding:8px;" placeholder="${colors[i].toUpperCase()} Name">`;
    }
    drawInputs();

    function launch() {
      const c = document.getElementById('pCount').value;
      for(let i=0; i<c; i++) {
        let name = document.getElementById('n'+i).value || colors[i];
        let startGrid = startSquares[i];
        let startIdxInOuter = outerRing.indexOf(startGrid);
        let pPath = [];
        
        // 1. Outer Path: 15 steps (Stops at the square behind home)
        for(let j=0; j<15; j++) pPath.push(outerRing[(startIdxInOuter + j) % 16]);
        
        // 2. Inner Turn-in (Starts from backside of home)
        const entryMap = { 
          2:  [7, 6, 11, 16, 17, 18, 13, 8],  // Red inner spiral
          22: [17, 18, 13, 8, 7, 6, 11, 16], // Blue inner spiral
          10: [11, 16, 17, 18, 13, 8, 7, 6], // Green inner spiral
          14: [13, 8, 7, 6, 11, 16, 17, 18]  // Yellow inner spiral
        };
        pPath.push(...entryMap[startGrid]);
        pPath.push(12); // Goal

        players.push({ name, color: colors[i], start: startGrid, path: pPath, tokens: [0,0,0,0], finished: 0 });
      }
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';
      buildBoard();
      updateUI();
    }

    function buildBoard() {
      const b = document.getElementById('gameBoard');
      for(let i=0; i<25; i++) {
        let div = document.createElement('div');
        div.className = 'cell';
        if([2,10,14,22].includes(i)) div.classList.add('safe');
        if([6,7,8,11,13,16,17,18].includes(i)) div.classList.add('inner-layer');
        // Side-parallel dark green waiting blocks
        if([7,11,13,17].includes(i)) div.classList.add('waiting-box');
        if(i === 12) div.classList.add('win-block', 'safe');
        b.appendChild(div);
        cells[i] = div;
      }
      players.forEach((p, pi) => {
        for(let ti=0; ti<4; ti++) {
          let t = document.createElement('div');
          t.className = `token ${p.color}-t`;
          t.onclick = (e) => handleToken(e, pi, ti, t);
          cells[p.start].appendChild(t);
          p['el'+ti] = t;
        }
      });
    }

    function throwKaude() {
      const btn = document.getElementById('tossBtn'); btn.disabled = true;
      let area = document.getElementById('cowrieArea'); area.innerHTML = '';
      
      // Traditional 4-cowrie roll
      let testH = 0;
      for(let i=0; i<4; i++) if(Math.random() < 0.5) testH++;
      
      // APPLYING 10% RARITY FOR 4 and 8
      let rarityCheck = Math.random() * 100;
      let finalH = ((testH === 4 || testH === 0) && rarityCheck > 10) ? (Math.floor(Math.random() * 3) + 1) : testH;
      
      // Visuals
      for(let i=0; i<4; i++) {
        let dot = document.createElement('div');
        dot.style.cssText = `width:30px; height:30px; border-radius:50%; border:2px solid black; background:${i < finalH ? 'white' : 'black'};`;
        dot.className = 'spinning'; area.appendChild(dot);
      }

      setTimeout(() => {
        roll = (finalH === 0) ? 8 : finalH;
        document.getElementById('score').innerText = "Roll: " + roll;
        if(roll === 4 || roll === 8) btn.disabled = false;
      }, 600);
    }

    function handleToken(e, pi, ti, el) {
      if(roll === 0 || pi !== turnIdx) return;
      e.stopPropagation(); clearHighlights();
      el.classList.add('selected');
      let nextIdx = players[pi].tokens[ti] + roll;
      if(nextIdx < players[pi].path.length) {
        let targetGrid = players[pi].path[nextIdx];
        cells[targetGrid].classList.add('highlight');
        cells[targetGrid].onclick = () => {
          // Kill logic (not on safe X)
          if(![2,10,12,14,22].includes(targetGrid)) {
            players.forEach((opp, oi) => {
              if(oi !== pi) {
                for(let k=0; k<4; k++) {
                  if(opp.path[opp.tokens[k]] === targetGrid && opp.tokens[k] !== 0) {
                    cells[opp.start].appendChild(opp['el'+k]);
                    opp.tokens[k] = 0;
                  }
                }
              }
            });
          }
          cells[targetGrid].appendChild(el);
          players[pi].tokens[ti] = nextIdx;
          if(targetGrid === 12) { el.style.display = 'none'; players[pi].finished++; checkWinner(pi); }
          if(roll === 4 || roll === 8) endTurn(false); else endTurn(true);
        };
      }
    }

    function checkWinner(pi) { if(players[pi].finished === 4) { alert(players[pi].name + " WINS!"); location.reload(); } }
    function clearHighlights() { document.querySelectorAll('.cell').forEach(c => { c.classList.remove('highlight'); c.onclick = null; }); document.querySelectorAll('.token').forEach(t => t.classList.remove('selected')); }
    function endTurn(skip) { if(skip) turnIdx = (turnIdx + 1) % players.length; roll = 0; clearHighlights(); updateUI(); document.getElementById('tossBtn').disabled = false; }
    function updateUI() { const p = players[turnIdx]; const b = document.getElementById('turn-box'); b.innerText = p.name.toUpperCase() + "'S TURN"; b.style.background = hex[p.color]; document.getElementById('score').innerText = "Roll: 0"; }
    
    // Fake boot sequence
    window.onload = () => setTimeout(() => { document.getElementById('boot-screen').style.display = 'none'; document.getElementById('setup-screen').style.display = 'flex'; }, 2000);
  </script>
</body>
</html>
