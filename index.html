<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kamat Studio - Kaude</title>

<style>
body{margin:0;font-family:sans-serif;background:#fff5e6;text-align:center}
#setup-screen,#game-container{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
#game-container{display:none}

.board{
display:grid;
grid-template-columns:repeat(5,1fr);
grid-template-rows:repeat(5,1fr);
width:94vw;height:94vw;
max-width:380px;max-height:380px;
border:4px solid #3e2723;
background:#FFFDD0;
}

.cell{border:1px solid #3e2723;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;position:relative}

.inner-layer{background:#e8f5e9}
.waiting-box{background:#a5d6a7;border:3px solid #2e7d32}
.win-block{background:#ffd700;border:3px double #3e2723}
.safe{
background-image:
linear-gradient(45deg,transparent 48%,#3e2723 50%,transparent 52%),
linear-gradient(-45deg,transparent 48%,#3e2723 50%,transparent 52%);
}

.highlight{background:rgba(46,125,50,0.4)!important;border:4px solid #2e7d32!important}

.token{
width:18px;height:18px;border-radius:50%;
border:1.5px solid #000;margin:1px;
transition:.3s;box-shadow:1px 1px 3px rgba(0,0,0,.3)
}

.red-t{background:#ff5252}
.blue-t{background:#2196f3}
.green-t{background:#4caf50}
.yellow-t{background:#ffeb3b}

.selected{transform:scale(1.8);box-shadow:0 0 15px #000;z-index:10;border-color:white}

button{
padding:14px 30px;background:#d32f2f;color:white;
border:none;border-radius:50px;font-weight:bold;font-size:18px;cursor:pointer;margin:8px
}

.turn-indicator{font-weight:bold;padding:10px 25px;border-radius:30px;color:white;margin:5px}

.cowrie{width:45px}
.spinning{animation:toss .6s}
@keyframes toss{0%{transform:scale(.5)}100%{transform:scale(1) rotate(-360deg)}}
</style>
</head>

<body>

<div id="setup-screen">
  <div style="background:white;padding:25px;border-radius:20px;width:85%;max-width:320px;box-shadow:0 5px 15px rgba(0,0,0,.2)">
    <h2 style="margin:0;color:#3e2723">Kamat Studio</h2>
    <p>Number of Players (2-4)</p>
    <input type="number" id="pCount" min="2" max="4" value="2" oninput="drawInputs()" style="width:60px;text-align:center;font-size:18px">
    <div id="pNames" style="margin:15px 0"></div>
    <button onclick="launch()">Start Kaude</button>
  </div>
</div>

<div id="game-container">
  <div id="turn-box" class="turn-indicator"></div>
  <div id="score" style="font-size:22px;font-weight:bold">Roll: 0</div>
  <div id="cowrieArea" style="display:flex;gap:8px;justify-content:center;min-height:60px"></div>
  <button id="tossBtn" onclick="throwKaude()">Toss Cowries</button>
  <div class="board" id="gameBoard"></div>
</div>

<script>
console.log("Kaude Final Loaded");

// ---- Board rings
const outerRing=[2,1,0,5,10,15,20,21,22,23,24,19,14,9,4,3];
const startSquares=[2,22,10,14];
const colors=['red','blue','green','yellow'];
const hex={red:'#ff5252',blue:'#2196f3',green:'#4caf50',yellow:'#ffeb3b'};

// ---- HOUSE BASED INNER PATHS (REAL LOGIC)
const innerPaths = {
  2:  [7,6,11,12],        // TOP → center
  22: [17,18,13,12],     // BOTTOM → center
  10: [11,16,17,12],     // RIGHT → center
  14: [13,8,7,12]        // LEFT → center
};

let players=[],turnIdx=0,roll=0,cells=[];

function drawInputs(){
 const c=document.getElementById('pCount').value;
 const box=document.getElementById('pNames'); box.innerHTML='';
 for(let i=0;i<c;i++){
  box.innerHTML+=`<input id="n${i}" placeholder="${colors[i].toUpperCase()} Name"
   style="width:85%;margin:5px;padding:8px">`;
 }
}
drawInputs();

function launch(){
 const c=document.getElementById('pCount').value;
 players=[];

 for(let i=0;i<c;i++){
  let name=document.getElementById('n'+i).value||colors[i];
  let start=startSquares[i];
  let startIdx=outerRing.indexOf(start);
  let path=[];

  // ---- Outer path
  for(let j=0;j<15;j++) path.push(outerRing[(startIdx+j)%16]);

  // ---- Correct inner path per house
  innerPaths[start].forEach(cell=>{
    path.push(cell);
  });

  players.push({name,color:colors[i],start,path,tokens:[0,0,0,0],finished:0});
 }

 document.getElementById('setup-screen').style.display='none';
 document.getElementById('game-container').style.display='flex';
 buildBoard(); updateUI();
}

function buildBoard(){
 const b=document.getElementById('gameBoard');
 b.innerHTML=''; cells=[];
 for(let i=0;i<25;i++){
  let d=document.createElement('div'); d.className='cell';
  if([2,10,14,22].includes(i)) d.classList.add('safe');
  if([6,7,8,11,13,16,17,18].includes(i)) d.classList.add('inner-layer');
  if([7,11,13,17].includes(i)) d.classList.add('waiting-box');
  if(i===12) d.classList.add('win-block','safe');
  b.appendChild(d); cells[i]=d;
 }

 players.forEach((p,pi)=>{
  for(let ti=0;ti<4;ti++){
   let t=document.createElement('div');
   t.className=`token ${p.color}-t`;
   t.onclick=e=>handleToken(e,pi,ti,t);
   cells[p.start].appendChild(t);
   p['el'+ti]=t;
  }
 });
}

function throwKaude(){
 const b=document.getElementById('tossBtn'); b.disabled=true;
 const a=document.getElementById('cowrieArea'); a.innerHTML='';
 let testH=0; for(let i=0;i<4;i++) if(Math.random()<0.5) testH++;
 let rawH=((testH===4||testH===0)&&Math.random()*100>10)?(Math.floor(Math.random()*3)+1):testH;

 for(let i=0;i<4;i++){
  let img=document.createElement('img');
  img.src=(i<rawH)?'hollow.png':'curved.png';
  img.className='cowrie spinning'; a.appendChild(img);
 }

 setTimeout(()=>{
  roll=(rawH===0)?8:rawH;
  document.getElementById('score').innerText="Roll: "+roll;
  if(roll===4||roll===8) b.disabled=false;
 },600);
}

function handleToken(e,pi,ti,el){
 if(roll===0||pi!==turnIdx) return;
 if(players[pi].tokens[ti]===players[pi].path.length-1) return;
 e.stopPropagation(); clear(); el.classList.add('selected');

 let next=players[pi].tokens[ti]+roll;
 if(next<players[pi].path.length){
  let target=players[pi].path[next];
  cells[target].classList.add('highlight');
  cells[target].onclick=()=>{
   if(![2,10,12,14,22].includes(target)){
    players.forEach((opp,oi)=>{
     if(oi!==pi){
      for(let k=0;k<4;k++){
       if(opp.path[opp.tokens[k]]===target && opp.tokens[k]!==0){
        cells[opp.start].appendChild(opp['el'+k]);
        opp.tokens[k]=0;
       }
      }
     }
    });
   }

   cells[target].appendChild(el);
   players[pi].tokens[ti]=next;

   if(next===players[pi].path.length-1){
    el.style.opacity="0.3"; players[pi].finished++; checkWinner(pi);
   }

   if(roll===4||roll===8) endTurn(false); else endTurn(true);
  }
 }
}

function checkWinner(pi){
 if(players[pi].finished===4){
  alert(players[pi].name+" WINS!");
  location.reload();
 }
}

function clear(){
 document.querySelectorAll('.cell').forEach(c=>{c.classList.remove('highlight');c.onclick=null});
 document.querySelectorAll('.token').forEach(t=>t.classList.remove('selected'));
}

function endTurn(skip){
 if(skip) turnIdx=(turnIdx+1)%players.length;
 roll=0; clear(); updateUI();
 document.getElementById('tossBtn').disabled=false;
}

function updateUI(){
 const p=players[turnIdx];
 const b=document.getElementById('turn-box');
 b.innerText=p.name.toUpperCase()+"'S TURN";
 b.style.background=hex[p.color];
 document.getElementById('score').innerText="Roll: 0";
}
</script>

</body>
</html>
